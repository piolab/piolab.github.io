"use strict";angular.module("cheerMathApp",["timer","LocalStorageModule"]),angular.module("cheerMathApp").controller("MainCtrl",["$scope","Gamemanagerservice","Mathservice","$timeout","$window","$log","localStorageService",function(a,b,c,d,e,f,g){a.startTimer=function(){a.$broadcast("timer-start")},a.stopTimer=function(){a.$broadcast("timer-stop")},a.clearTimer=function(){a.$broadcast("timer-clear")},a.resetTimer=function(){a.$broadcast("timer-reset")},a.newGame=function(){a.expression=b.generate(0),a.checkingAnswer=!1,a.gameOver=!1,a.resetTimer(),a.score=0,a.consecutiveNumber=0,a.level=1},a.init=function(){a.trueAudio=document.createElement("audio"),a.trueAudio.src="http://piolab.github.io/cheer-math/media/right_answer.mp3",a.trueAudio.load(),a.trueAudio.addEventListener("loadeddata",function(){a.trueAudio.onloaded=!0}),a.wrongAudio=document.createElement("audio"),a.wrongAudio.src="http://piolab.github.io/cheer-math/media/wrong_answer.mp3",a.wrongAudio.load(),a.wrongAudio.addEventListener("loadeddata",function(){a.wrongAudio.onloaded=!0});var b=g.get("cheer-math-score");a.bestScore=b,a.newGame()},a.playTrueAudio=function(){a.trueAudio.onloaded&&(a.trueAudio.play(),a.trueAudio.currentTime=0)},a.playWrongAudio=function(){a.wrongAudio.onloaded&&(a.wrongAudio.play(),a.wrongAudio.currentTime=0)},a.init(),a.nextGame=function(){a.expression=b.generate(a.level-1),a.checkingAnswer=!1},a.gameCheck=function(){0===a.score&&a.startTimer(),a.checkingAnswer=!0;var c=a.expression.chain.indexOf(-1);return-1!==c?(a.showTrue=!1,a.gameOver=!0,a.stopTimer(),!1):(a.showTrue=b.isCorrectExpression(a.expression),a.showTrue?(a.playTrueAudio(),a.consecutiveNumber++,a.consecutiveNumber>=5&&(a.level<4&&a.level++,a.consecutiveNumber=0,a.$broadcast("timer-add-cd-seconds",4+a.level)),a.score++):(a.gameOver=!0,a.stopTimer()),a.showTrue)},a.updateBestScore=function(){a.score>a.bestScore&&(a.bestScore=a.score,g.add("cheer-math-score",a.bestScore))},a.plusButtonClick=function(){if(!a.gameOver){var b=a.expression.chain.indexOf(-1);-1!==b&&(a.expression.chain[b]=0,b=a.expression.chain.indexOf(-1),-1===b&&(a.gameCheck()?d(a.nextGame,300):(a.playWrongAudio(),a.updateBestScore(),a.checkingAnswer=!1)))}},a.minusButtonClick=function(){if(!a.gameOver){var b=a.expression.chain.indexOf(-1);-1!==b&&(a.expression.chain[b]=1,b=a.expression.chain.indexOf(-1),-1===b&&(a.gameCheck()?d(a.nextGame,300):(a.playWrongAudio(),a.updateBestScore(),a.checkingAnswer=!1)))}},a.$on("timer-stopped",function(){a.gameOver=!0,a.$apply(),a.stopTimer()}),a.$on("timer-tick",function(){}),a.onKeyDown=function(b){37===b.keyCode?a.plusButtonClick():39===b.keyCode?a.minusButtonClick():(38===b.keyCode||40===b.keyCode)&&a.gameOver&&a.newGame()}}]),angular.module("cheerMathApp").factory("Mathservice",function(){return{getRandomNumber:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},generateExpression:function(a){for(var b=[],c=0;c<a.numOfFactor-1;c++)b.push(this.getRandomNumber(0,a.numOfFactor-2));var d=[],e=this.getRandomNumber(a.min,a.max),f=e;d.push(e);for(var g=this.getRandomNumber(1,a.numOfFactor-1),c=1;c<a.numOfFactor;c++){{var h=this.getRandomNumber(a.min,a.max),i=this.getRandomNumber(0,1);-1!==b.indexOf(c-1)}d.push(c===g?-1:i),d.push(h),0===i?f+=h:1===i&&(f-=h)}return{chain:d,result:f}}}}),angular.module("cheerMathApp").factory("Gamemanagerservice",["Mathservice",function(a){var b=[{min:0,max:10,numOfFactor:2},{min:0,max:20,numOfFactor:2},{min:0,max:10,numOfFactor:3},{min:0,max:30,numOfFactor:3}];return{generate:function(c){return a.generateExpression(b[c])},isCorrectExpression:function(a){for(var b=a.chain,c=b[0],d=1;d<b.length-1;d+=2)if(0===b[d])c+=b[d+1];else{if(1!==b[d])return!1;c-=b[d+1]}return a.result===c}}}]);